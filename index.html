<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YUMEKO SUSHIS — Menu</title>

  <!-- Police Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Favicon / thème -->
  <link rel="icon" type="image/png" href="images/favicon.png" />
  <link rel="apple-touch-icon" href="images/favicon.png" />
  <meta name="theme-color" content="#8b0000" />

  <style>
    :root{
      --brand:#8b0000; --brand-2:#a31212; --text:#f8f8f8;
      --card:#1b1b1b; --muted:#cfcfcf; --accent:#ffb6b6; --accent-2:#ff8c8c;
      --gold:#d8b26e; --barShade:.35;
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; scroll-behavior:smooth; }
    body{
      margin:0;
      font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#0f0f0f 0%, #8b0000 100%); /* identique à accueil */
      color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Header (identique à accueil, sans japonais ni panier) ===== */
    .site-header.jp{
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.35));
      border-bottom: 1px solid rgba(255,255,255,.08);
      position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(120%) blur(6px);
    }
    .site-header .header-inner{
      width:min(96%,1100px); margin:0 auto;
      padding:14px 8px 10px;
      display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    a.brand{ display:flex; flex-direction:column; align-items:center; gap:6px; text-decoration:none; }
    .logo{
      width:160px; height:160px; border-radius:50%;
      object-fit:cover; background:#000; box-shadow:0 0 10px rgba(0,0,0,.3);
      display:block;
    }
    @media (min-width:768px){ .logo{ width:200px; height:200px; } }
    .brand-text h1{
      margin:0; letter-spacing:2px; font-weight:800; font-size:1.4rem; color:var(--text); text-align:center;
    }

    .main-nav{
      display:flex; align-items:center; gap:8px; margin-top:6px; font-weight:600;
    }
    .main-nav .sep{ color:#e9d9d9; opacity:.6; }
    .main-nav a{
      color:var(--text); text-decoration:none; padding:6px 10px; border-radius:10px; opacity:.95;
      transition:filter .15s ease, transform .15s ease;
    }
    .main-nav a:hover{ opacity:1; transform:translateY(-1px); }
    .main-nav a.active{ background:rgba(255,255,255,.08); }
    @media (max-width:480px){ .brand-text h1{ font-size:1.2rem; } }

    /* ===== Page ===== */
    .container{ max-width:1100px; margin:0 auto; padding:22px; }
    .section{
      background:#160c0c; border:1px solid rgba(255,255,255,.08); border-radius:18px;
      padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.25); margin-bottom:22px;
    }
    .section h2{ margin:0 0 8px; font-size:1.65rem; letter-spacing:.5px; }
    .sep{ height:2px; width:64px; background:linear-gradient(90deg,var(--gold),transparent); border-radius:2px; margin:6px 0 16px; }

    /* ===== GRID menu ===== */
    .menu-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:14px; }
    .item-card{
      background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:14px; overflow:hidden;
      cursor:pointer; transition:transform .12s, box-shadow .12s;
      display:flex; flex-direction:column;
    }
    .item-card:hover{ transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .thumb{ width:100%; aspect-ratio:1/1; object-fit:cover; display:block; background:#0d0d0d; }
    .item-name{ font-weight:700; font-size:.98rem; padding:10px 12px 4px; }
    .card-body{ padding:0 12px 12px; margin-top:auto; }
    .card-footer{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      padding-top:10px; border-top:1px dashed rgba(255,255,255,.08);
    }
    .meta{ display:flex; flex-direction:column; gap:2px; align-items:flex-start; line-height:1.15; }
    .pieces{ font-size:.78rem; color:var(--muted); }
    .price{ font-size:.86rem; font-weight:700; }

    .ctrls{ display:flex; align-items:center; gap:8px; }
    .circle{
      background:var(--accent); border:none; color:#111; width:36px; height:36px; border-radius:50%;
      font-weight:900; cursor:pointer; transition:transform .15s ease, filter .15s ease;
    }
    .circle:hover{ background:var(--accent-2); transform:scale(1.06); }
    .qty-badge{ min-width:22px; text-align:center; font-weight:800; }
    .qty-badge:empty{ display:none; }
    .qty.bump{ transform:scale(1.15); transition:transform .2s; }

    @media (max-width:480px){
      .menu-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; }
      .item-card{ border-radius:12px; }
      .item-name{ font-size:.9rem; padding:8px 10px 2px; }
      .card-body{ padding:0 10px 10px; }
      .circle{ width:34px; height:34px; }
    }

    /* ===== Sticky bar + tiroir ===== */
    #stickyBar{
      position:fixed; bottom:0; left:0; right:0; z-index:100;
      background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,var(--barShade)));
      padding:6px;
    }
    #stickyInner{ width:min(96%,1100px); margin:0 auto; display:flex; flex-direction:column; gap:8px; align-items:center; }
    #miniRecap{ display:none !important; }
    #gotoOrder{
      background:var(--brand); color:#fff; font-weight:900; border:none; border-radius:12px;
      padding:12px 16px; cursor:pointer; white-space:nowrap;
      transition:filter .15s ease, transform .15s ease;
    }
    #gotoOrder:hover{ filter:brightness(1.05); transform:translateY(-1px); }

    #cartSheet{
      position:fixed; left:50%; transform:translateX(-50%); bottom:-100%;
      width:min(96%,1100px); background:#1b1b1b; color:#fff;
      border:1px solid rgba(255,255,255,.12); border-radius:16px 16px 0 0;
      box-shadow:0 22px 60px rgba(0,0,0,.45); max-height:70vh;
      display:flex; flex-direction:column; transition:bottom .28s ease; z-index:101;
      overscroll-behavior:contain;
    }
    #cartSheet.open{ bottom:0; }
    #cartSheet header, #cartSheet footer{ padding:8px 12px; display:flex; align-items:center; justify-content:space-between; }
    #cartSheet header{ border-bottom:1px solid rgba(255,255,255,.1); }
    #cartSheet footer{ border-top:1px solid rgba(255,255,255,.1); gap:10px; justify-content:flex-end; }
    #cartSheet .body{
      padding:8px 10px; overflow:auto; -webkit-overflow-scrolling:touch;
      max-height:calc(70vh - 100px); overscroll-behavior:contain;
    }
    .recap-list{
      list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px;
      max-height:48vh; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .recap-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,.1); }

    .btn-ghost, .btn-primary{ border:none; border-radius:12px; padding:10px 14px; font-weight:900; cursor:pointer; }
    .btn-ghost{ background:#2a2a2a; color:#fff; } .btn-ghost:hover{ filter:brightness(1.1); }
    .btn-primary{ background:var(--brand); color:#fff; } .btn-primary:hover{ background:var(--brand-2); }
    .btn-primary[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Accessibilité / focus */
    :focus-visible{ outline:2px solid #fff; outline-offset:3px; }
    @media (prefers-reduced-motion:reduce){
      *{ transition:none !important; animation:none !important; scroll-behavior:auto; }
    }
  </style>
</head>
<body>

  <!-- ===== Header (même que accueil) ===== -->
  <header class="site-header jp">
    <div class="header-inner">
      <a href="accueil.html" class="brand" aria-label="Accueil - YUMEKO SUSHIS">
        <img src="images/logo-yumeko.png" alt="YUMEKO SUSHIS" class="logo" loading="eager" decoding="async" />
        <div class="brand-text"><h1>YUMEKO SUSHIS</h1></div>
      </a>

      <nav class="main-nav" aria-label="Navigation principale">
        <a href="accueil.html">Accueil</a>
        <span class="sep" aria-hidden="true">・</span>
        <a href="index.html" class="active">Menu</a>
      </nav>
    </div>
  </header>

  <!-- Pas de HERO (pour éviter bandeau rouge doublon) -->

  <main class="container">
    <!-- MENU -->
    <section class="section" id="menuSection" aria-labelledby="titre-menu">
      <h2 id="titre-menu">Notre carte</h2>
      <div class="sep" aria-hidden="true"></div>
      <div id="menu"></div>
    </section>
  </main>

  <!-- BANDEAU PANIER -->
  <div id="stickyBar" aria-live="polite">
    <div id="stickyInner">
      <span id="miniRecap"></span>
      <button id="gotoOrder" type="button">Panier (0) • Valider</button>
    </div>
  </div>

  <!-- TIROIR RÉCAP / 2 ÉTAPES -->
  <div id="cartSheet" aria-hidden="true">
    <header>
      <h3>Valider votre commande</h3>
      <button id="sheetClose" aria-label="Fermer" type="button">×</button>
    </header>
    <div class="body">
      <div id="stepCart" class="step active">
        <p class="muted" id="sheetIntro">Vérifie ton panier et ajuste les quantités :</p>
        <ul class="recap-list" id="recapList"></ul>
        <div id="recapComment" class="muted" style="margin-top:4px;"></div>
      </div>
      <div id="stepDetails" class="step"></div>
    </div>
    <footer>
      <div id="footerCart" class="step active">
        <button class="btn-primary" id="goDetails" type="button">Valider le panier →</button>
      </div>
      <div id="footerDetails" class="step">
        <button class="btn-ghost" id="backToCart" type="button">← Retour</button>
        <button class="btn-primary" id="confirmSend" type="button">Confirmer et envoyer</button>
      </div>
    </footer>
  </div>

  <footer style="text-align:center; color:#d7d7d7; margin:28px 0 36px; font-size:.95rem;">
    © 2025 YUMEKO SUSHIS — Les sushis qui font ronronner vos papilles
  </footer>

  <!-- =========================
       Données + Construction du menu
  ========================== -->
  <script>
    const categories={
      'LES MAKI':['M1','M2','M3','M4','M5','M6','M7','M8'],
      'LES CALIFORNIA':['C1','C2','C3','C4','C5','C6','C7','C8','C9'],
      'LES MAKI PRINTEMPS':['P1','P2','P3','P4'],
      'LES ROLLS':['R1','R2'],
      'LES SASHIMI':['S1'],
      'LES NIGIRI':['N1','N2'],
      'LES BOISSONS':['B1','B2','B3']
    };
    const catalog={
      M1:{name:'MAKI SAUMON', img:'m1.jpg', pieces:6, comp:'Riz, nori, saumon', allergens:'Poisson', desc:''},
      M2:{name:'MAKI SAUMON AVOCAT', img:'m2.jpg', pieces:6, comp:'Riz, nori, saumon, avocat', allergens:'Poisson', desc:''},
      M3:{name:'MAKI SAUMON CHEESE', img:'m3.jpg', pieces:6, comp:'Riz, nori, saumon, fromage frais', allergens:'Poisson, Lait', desc:''},
      M4:{name:'MAKI CONCOMBRE', img:'m4.jpg', pieces:6, comp:'Riz, nori, concombre', allergens:'—', desc:''},
      M5:{name:'MAKI CONCOMBRE CHEESE', img:'m5.jpg', pieces:6, comp:'Riz, nori, concombre, fromage', allergens:'Lait', desc:''},
      M6:{name:'MAKI AVOCAT', img:'m6.jpg', pieces:6, comp:'Riz, nori, avocat', allergens:'—', desc:''},
      M7:{name:'MAKI AVOCAT CHEESE', img:'m7.jpg', pieces:6, comp:'Riz, nori, avocat, fromage', allergens:'Lait', desc:''},
      M8:{name:'MAKI CHEESE', img:'m8.jpg', pieces:6, comp:'Riz, nori, fromage', allergens:'Lait', desc:''},
      C1:{name:'CALIFORNIA SAUMON', img:'c1.jpg', pieces:8, comp:'Riz, nori, saumon, sésame', allergens:'Poisson, Sésame', desc:''},
      C2:{name:'CALIFORNIA SAUMON AVOCAT', img:'c2.jpg', pieces:8, comp:'Riz, nori, saumon, avocat', allergens:'Poisson', desc:''},
      C3:{name:'CALIFORNIA SAUMON CHEESE', img:'c3.jpg', pieces:8, comp:'Riz, nori, saumon, fromage', allergens:'Poisson, Lait', desc:''},
      C4:{name:'CALIFORNIA CONCOMBRE', img:'c4.jpg', pieces:8, comp:'Riz, nori, concombre', allergens:'—', desc:''},
      C5:{name:'CALIFORNIA CONCOMBRE CHEESE', img:'c5.jpg', pieces:8, comp:'Riz, nori, concombre, fromage', allergens:'Lait', desc:''},
      C6:{name:'CALIFORNIA AVOCAT', img:'c6.jpg', pieces:8, comp:'Riz, nori, avocat', allergens:'—', desc:''},
      C7:{name:'CALIFORNIA AVOCAT CHEESE', img:'c7.jpg', pieces:8, comp:'Riz, nori, avocat, fromage', allergens:'Lait', desc:''},
      C8:{name:'CALIFORNIA CHEESE', img:'c8.jpg', pieces:8, comp:'Riz, nori, fromage', allergens:'Lait', desc:''},
      C9:{name:'CALIFORNIA SAUMON CHEESE OIGNONS FRITS', img:'c9.jpg', pieces:8, comp:'Riz, nori, saumon, fromage, oignons frits', allergens:'Poisson, Lait, Gluten', desc:''},
      P1:{name:'MAKI PRINTEMPS SAUMON AVOCAT', img:'p1.jpg', pieces:6, comp:'Riz, feuille de riz, saumon, avocat', allergens:'Poisson', desc:''},
      P2:{name:'MAKI PRINTEMPS SAUMON CHEESE', img:'p2.jpg', pieces:6, comp:'Riz, feuille de riz, saumon, fromage', allergens:'Poisson, Lait', desc:''},
      P3:{name:'MAKI PRINTEMPS CONCOMBRE CHEESE', img:'p3.jpg', pieces:6, comp:'Riz, feuille de riz, concombre, fromage', allergens:'Lait', desc:''},
      P4:{name:'MAKI PRINTEMPS AVOCAT CHEESE', img:'p4.jpg', pieces:6, comp:'Riz, feuille de riz, avocat, fromage', allergens:'Lait', desc:''},
      R1:{name:'ROLLS SAUMON AVOCAT CHEESE', img:'r1.jpg', pieces:8, comp:'Riz, nori, saumon, avocat, fromage', allergens:'Poisson, Lait', desc:''},
      R2:{name:'ROLLS AVOCAT SAUMON CHEESE', img:'r2.jpg', pieces:8, comp:'Riz, nori, avocat, saumon, fromage', allergens:'Poisson, Lait', desc:''},
      S1:{name:'SASHIMI SAUMON', img:'s1.jpg', pieces:2, comp:'Tranches de saumon', allergens:'Poisson', desc:''},
      N1:{name:'NIGIRI SAUMON', img:'n1.jpg', pieces:2, comp:'Riz, saumon', allergens:'Poisson', desc:''},
      N2:{name:'NIGIRI AVOCAT', img:'n2.jpg', pieces:2, comp:'Riz, avocat', allergens:'—', desc:''},
      B1:{name:'BIERE TSINGTAO', img:'b1.jpg'},
      B2:{name:'BIERE ASAHI', img:'b2.jpg'},
      B3:{name:'COCA COLA ZERO', img:'b3.jpg'}
    };
    const prices={}; // optionnel
    const fmt=new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});

    function buildMenu(){
      const menu=document.getElementById('menu'); menu.innerHTML='';
      for(const [cat,codes] of Object.entries(categories)){
        const wrap=document.createElement('div'); wrap.className='category';
        wrap.innerHTML=`<h3 style="text-align:center;text-transform:uppercase;letter-spacing:1px;margin:0 0 18px">${cat}</h3><div class="menu-grid"></div>`;
        const grid=wrap.querySelector('.menu-grid');

        codes.forEach(code=>{
          const d=catalog[code]||{name:code, img:code.toLowerCase()+'.jpg'};
          const name=d.name||code;
          const img='images/'+(d.img || (code.toLowerCase()+'.jpg'));
          const pieces=d.pieces ?? '';
          const basePrice=(prices.hasOwnProperty(code)?prices[code]:(typeof d.price==='number'?d.price:undefined));
          const priceStr=(typeof basePrice==='number')? fmt.format(basePrice) : '—';

          const card=document.createElement('div'); card.className='item-card'; card.dataset.code=code; card.dataset.name=name;
          card.innerHTML=`
            <img class="thumb" loading="lazy" decoding="async" src="${img}" alt="${name}" onerror="this.style.display='none'">
            <div class="item-name">${name}</div>
            <div class="card-body">
              <div class="card-footer">
                <div class="meta">
                  <span class="pieces">${pieces? pieces+' PIECES' : ''}</span>
                  <span class="price">${priceStr}</span>
                </div>
                <div class="ctrls">
                  <span class="qty-badge qty" data-item="${code}- ${name}"></span>
                  <button class="circle card-plus" data-item="${code}- ${name}" type="button" aria-label="Ajouter ${name}">+</button>
                </div>
              </div>
            </div>`;
          grid.appendChild(card);
        });

        menu.appendChild(wrap);
      }
    }
    document.addEventListener('DOMContentLoaded', buildMenu);
  </script>

  <!-- Utilitaires & bandeau -->
  <script>
    (function(){
      if(typeof window.CSS==='undefined') window.CSS={};
      if(typeof window.CSS.escape!=='function'){
        window.CSS.escape=function(sel){ return String(sel).replace(/[\0-\x1F\x7F"#%&'()*+,./:;<=>?@\[\]^`{|}~]/g,'\\$&'); };
      }
    })();
    (function(){
      const root=document.documentElement;
      function updateBarShade(){
        const doc=document.documentElement;
        const max=(doc.scrollHeight - window.innerHeight) || 1;
        const p=Math.min(1, Math.max(0, window.scrollY/max));
        const shade=0.35 + (0.85-0.35)*p;
        root.style.setProperty('--barShade', shade.toFixed(2));
      }
      updateBarShade();
      window.addEventListener('scroll', updateBarShade, {passive:true});
      window.addEventListener('resize', updateBarShade);
    })();
  </script>

  <!-- Panier / tiroir / formulaire -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const sheet = document.getElementById('cartSheet');
      const sheetClose = document.getElementById('sheetClose');
      const btnOpen = document.getElementById('gotoOrder');
      const btnGoDetails = document.getElementById('goDetails');
      const btnBack = document.getElementById('backToCart');
      const btnConfirm = document.getElementById('confirmSend');

      const recapList = document.getElementById('recapList');
      const recapCom = document.getElementById('recapComment');
      const form = document.getElementById('orderForm');

      const stepCart = document.getElementById('stepCart');
      const stepDetails = document.getElementById('stepDetails');

      if(form && !stepDetails.contains(form)) stepDetails.appendChild(form);

      function safeInt(el){ return Math.max(0, parseInt(el?.textContent ?? '0') || 0); }
      function bump(el){ el.classList.add('bump'); setTimeout(()=>el.classList.remove('bump'),200); }

      function parseItem(full){
        const parts=String(full).split('-');
        const code=(parts[0]||'').trim();
        const name=parts.slice(1).join('-').trim()||full.trim();
        return {code,name};
      }
      function getCartItems(){
        const items=[];
        document.querySelectorAll('.qty[data-item]').forEach(span=>{
          const qty=safeInt(span);
          if(qty>0){
            const full=span.dataset.item;
            const {code,name}=parseItem(full);
            items.push({code,name,qty});
          }
        });
        return items;
      }

      function buildRecap(){
        const items=getCartItems();
        recapList.innerHTML='';
        if(items.length===0){
          recapList.innerHTML='<li class="muted">Aucun article pour le moment.</li>';
        }else{
          items.forEach(({code,name,qty})=>{
            const li=document.createElement('li');
            li.className='recap-item';
            const codeLower=(code||'').toLowerCase();
            li.innerHTML=`
              <div class="it-left" style="display:flex;align-items:center;gap:10px;min-width:0;flex:1">
                <img class="thumb sm" loading="lazy" decoding="async" src="images/${codeLower}.jpg" alt="${name}" onerror="this.style.display='none'">
                <span class="it-label" style="min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</span>
              </div>
              <div class="it-ctrl" style="display:flex;align-items:center;gap:8px">
                <button class="btn recap-minus" data-item="${code}- ${name}" aria-label="Retirer ${name}" type="button">−</button>
                <span class="qty" aria-live="polite">${qty}</span>
                <button class="btn recap-plus" data-item="${code}- ${name}" aria-label="Ajouter ${name}" type="button">+</button>
              </div>`;
            recapList.appendChild(li);
          });
        }
        const c=document.getElementById('comments')?.value?.trim()||'';
        recapCom.textContent = c ? `Allergies / autres : ${c}` : '';
      }

      function setStep(which){
        const showCart = which==='cart';
        const showDetails = which==='details';
        stepCart.classList.toggle('active', showCart);
        document.getElementById('footerCart').classList.toggle('active', showCart);
        stepDetails.classList.toggle('active', showDetails);
        document.getElementById('footerDetails').classList.toggle('active', showDetails);
      }

      const lockBgScroll = (e)=>{
        if(!document.body.classList.contains('modal-open')) return;
        if(!sheet.contains(e.target)){ e.preventDefault(); }
      };
      function openSheet(){
        setStep('cart'); buildRecap();
        sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
        document.body.classList.add('modal-open');
        window.addEventListener('touchmove', lockBgScroll, {passive:false});
        window.addEventListener('wheel', lockBgScroll, {passive:false});
      }
      function closeSheet(){
        sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true');
        document.body.classList.remove('modal-open');
        window.removeEventListener('touchmove', lockBgScroll);
        window.removeEventListener('wheel', lockBgScroll);
      }

      btnOpen?.addEventListener('click', openSheet);
      sheetClose?.addEventListener('click', closeSheet);
      btnGoDetails?.addEventListener('click', ()=> setStep('details'));
      btnBack?.addEventListener('click', ()=> setStep('cart'));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && sheet.classList.contains('open')) closeSheet(); });

      function ensureHiddenField(name){
        if(!form) return null;
        let input=form.querySelector(`input[name="${name}"]`);
        if(!input){ input=document.createElement('input'); input.type='hidden'; input.name=name; form.appendChild(input); }
        return input;
      }
      function buildOrderText(){
        const itemsText=getCartItems().map(({name,qty})=>`- ${name} x${qty}`).join('\n');
        const c=document.getElementById('comments')?.value?.trim() || '—';
        const first=form?.querySelector('[name="first_name"]')?.value || '—';
        const last =form?.querySelector('[name="last_name"]')?.value || '—';
        const email=form?.querySelector('[name="email"]')?.value || '—';

        return `Commande YUMEKO
Client : ${first} ${last}
Email : ${email}

Articles :
${itemsText || '(aucun)'}

Allergies / autres :
${c}`;
      }
      function prepareOrderText(){
        const text = buildOrderText();
        const hidden = ensureHiddenField('order'); if(hidden) hidden.value=text;
        const hiddenOrder = document.getElementById('hiddenOrder'); if(hiddenOrder) hiddenOrder.value=text;
        try{ localStorage.setItem('yumeko_last_order', text); }catch(e){}
        return text;
      }

      document.getElementById('confirmSend')?.addEventListener('click', async ()=>{
        if(!form) return;
        if(!form.reportValidity()){
          setStep('details'); form.querySelector(':invalid')?.focus(); return;
        }
        prepareOrderText();

        const fd = new FormData(form);
        fd.delete('_next');

        const btn = document.getElementById('confirmSend');
        btn.disabled = true; const old = btn.textContent; btn.textContent = 'Envoi…';

        try{
          await fetch(form.action, { method:'POST', body: fd, headers:{ 'Accept':'application/json' } });
        }catch(e){
          console.warn('FormSubmit error:', e);
        }finally{
          document.querySelectorAll('.qty[data-item]').forEach(q=>q.textContent='');
          updateSticky();
          window.location.href = 'merci.html';
        }

        btn.disabled = false; btn.textContent = old;
      });

      document.getElementById('cartSheet').addEventListener('input', (e)=>{
        if(e.target.matches('textarea,input')){ buildRecap(); updateSticky(); }
      });
      recapList.addEventListener('click', (e)=>{
        const plus = e.target.closest('.recap-plus');
        const minus = e.target.closest('.recap-minus');
        const btn = plus || minus;
        if(!btn) return;
        const item = btn.dataset.item;
        const span = document.querySelector(`.qty[data-item="${CSS.escape(item)}"]`);
        if(!span) return;
        const cur = parseInt(span.textContent)||0;
        const inc = plus ? 1 : -1;
        const v = Math.max(0, cur + inc);
        span.textContent = v>0 ? String(v) : '';
        bump(span);
        updateSticky();
        buildRecap();
      });

      document.addEventListener('click', (e)=>{
        const plusBtn = e.target.closest('.card-plus');
        const card = e.target.closest('.item-card');

        if(plusBtn){
          const itemKey = plusBtn.dataset.item;
          openItemModalByKey(itemKey);
          return;
        }
        if(card && !e.target.closest('.ctrls')){
          const code=card.dataset.code;
          const name=card.dataset.name;
          openItemModal(code, name);
          return;
        }
      });

      function openItemModal(code, name){
        const d=catalog[code]||{};
        const img='images/'+(d.img || (code.toLowerCase()+'.jpg'));
        document.getElementById('mImg').src=img;
        document.getElementById('mImg').alt=name;
        document.getElementById('mTitle').textContent=name;
        document.getElementById('mPieces').textContent=d.pieces ?? '—';
        document.getElementById('mAllergens').textContent=d.allergens || 'Non renseigné';
        document.getElementById('mComp').textContent=d.comp || 'Non renseigné';
        document.getElementById('mDesc').textContent=d.desc || '—';

        const itemKey=`${code}- ${name}`;
        const qtySpan=document.querySelector(`.qty[data-item="${CSS.escape(itemKey)}"]`);
        const current=parseInt(qtySpan?.textContent)||0;
        const mQty=document.getElementById('mQty');
        const mMinus=document.getElementById('mMinus');
        mQty.textContent=current;
        mMinus.style.visibility=current>0?'visible':'hidden';
        mMinus.dataset.item=itemKey;
        document.getElementById('mPlus').dataset.item=itemKey;

        const modal=document.getElementById('itemModal');
        modal.style.display='flex';
        modal.setAttribute('aria-hidden','false');
      }
      function openItemModalByKey(itemKey){
        const code = (String(itemKey).split('-')[0]||'').trim();
        const name = String(itemKey).split('-').slice(1).join('-').trim();
        if(!code || !name) return;
        openItemModal(code, name);
      }

      (function(){
        const modal=document.getElementById('itemModal');
        const closeBtn=document.getElementById('mClose');
        const mMinus=document.getElementById('mMinus');
        const mPlus=document.getElementById('mPlus');
        const mQty=document.getElementById('mQty');

        function setQty(itemKey,newVal){
          const span=document.querySelector(`.qty[data-item="${CSS.escape(itemKey)}"]`);
          if(!span) return;
          span.textContent = newVal>0 ? String(newVal) : '';
          mQty.textContent=newVal;
          document.getElementById('mMinus').style.visibility=newVal>0?'visible':'hidden';
          updateSticky(); buildRecap();
        }
        mMinus.addEventListener('click', ()=>{ const key=mMinus.dataset.item; if(!key) return; const cur=parseInt(mQty.textContent)||0; setQty(key, Math.max(0,cur-1)); });
        mPlus .addEventListener('click', ()=>{ const key=mPlus.dataset.item ; if(!key) return; const cur=parseInt(mQty.textContent)||0; setQty(key, cur+1); });

        closeBtn.addEventListener('click', ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } );
        modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='flex'){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });
      })();

      const CART_KEY='yumeko_cart_v1';
      function saveCart(){
        const cart=[];
        document.querySelectorAll('.qty[data-item]').forEach(q=>{
          const n=parseInt(q.textContent)||0;
          if(n>0) cart.push({key:q.dataset.item, qty:n});
        });
        try{ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }catch(e){}
      }
      function restoreCart(){
        try{
          const saved = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
          saved.forEach(({key,qty})=>{
            const span=document.querySelector(`.qty[data-item="${CSS.escape(key)}"]`);
            if(span){ span.textContent=qty; }
          });
          updateSticky();
        }catch(e){ console.warn('restoreCart error', e); }
      }

      function updateMiniRecap(){}
      function updateSticky(){
        const qtyNodes=document.querySelectorAll('.qty[data-item]'); let totalQty=0; let totalPrice=0;
        qtyNodes.forEach(q=>{
          const n=parseInt(q.textContent)||0; totalQty+=n;
          if(n>0){
            const full=q.dataset.item; const code=(String(full).split('-')[0]||'').trim();
            const d=window.catalog?.[code] || {};
            const p=(window.prices && Object.prototype.hasOwnProperty.call(window.prices, code))
                      ? window.prices[code]
                      : (typeof d.price==='number'?d.price:undefined);
            if(typeof p==='number') totalPrice += p*n;
          }
        });
        const btn=document.getElementById('gotoOrder'); if(!btn) return;
        if(totalPrice>0){
          const totalFmt=new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(totalPrice);
          btn.textContent = `Panier (${totalQty}) • Total ${totalFmt} • Valider`;
        }else{
          btn.textContent = `Panier (${totalQty}) • Valider`;
        }
        updateMiniRecap(); saveCart();
      }

      if(location.hash==='#panier' || location.hash==='#cart') { setTimeout(()=>btnOpen?.click(),0); }

      restoreCart();
      updateSticky();
    });
  </script>

  <!-- Nav actif (comme sur accueil) -->
  <script>
    (function(){
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.main-nav a').forEach(a=>{
        const href = a.getAttribute('href');
        if(href && !href.startsWith('#') && here === href) a.classList.add('active');
      });
    })();
  </script>
</body>
</html>
